"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[849],{4365:(e,a,n)=>{n.d(a,{A:()=>o});const o=n.p+"assets/images/poc-k8s-helm-opa-a0433a1c033d0c1e31f0d9086a9af9d6.png"},5296:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>d,contentTitle:()=>l,default:()=>u,frontMatter:()=>r,metadata:()=>o,toc:()=>c});const o=JSON.parse('{"id":"multi-tenant/poc-multi-tenant-k8s-helm-opa","title":"Aplica\xe7\xf5es multi-tenant com Kubernetes e Helm","description":"Introdu\xe7\xe3o","source":"@site/docs/multi-tenant/poc-multi-tenant-k8s-helm-opa.md","sourceDirName":"multi-tenant","slug":"/multi-tenant/poc-multi-tenant-k8s-helm-opa","permalink":"/library/multi-tenant/poc-multi-tenant-k8s-helm-opa","draft":false,"unlisted":false,"tags":[{"inline":false,"label":"Kubernetes","permalink":"/library/tags/k8s","description":"Kubernetes is an open-source system for automating container deployment, scaling, and management across infrastructure."},{"inline":false,"label":"Open Policy Agent","permalink":"/library/tags/opa","description":"A general-purpose policy engine that enables fine-grained access control and policy enforcement across cloud-native stacks."},{"inline":false,"label":"Multi-Tenant","permalink":"/library/tags/multi-tenant","description":"Architecture pattern where a single software serves multiple customers (tenants) with strategies of data isolation and shared resources."}],"version":"current","frontMatter":{"slug":"poc-multi-tenant-k8s-helm-opa","title":"Aplica\xe7\xf5es multi-tenant com Kubernetes e Helm","tags":["k8s","opa","multi-tenant"]},"sidebar":"tutorialSidebar","previous":{"title":"Multi-tenant","permalink":"/library/multi-tenant"},"next":{"title":"FinOps","permalink":"/library/finops"}}');var t=n(4848),s=n(8453),i=n(5594);const r={slug:"poc-multi-tenant-k8s-helm-opa",title:"Aplica\xe7\xf5es multi-tenant com Kubernetes e Helm",tags:["k8s","opa","multi-tenant"]},l=void 0,d={},c=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"Containers",id:"containers",level:2},{value:"Roteamento e autoriza\xe7\xe3o",id:"roteamento-e-autoriza\xe7\xe3o",level:2},{value:"Execute localmente",id:"execute-localmente",level:2},{value:"Refer\xeancias",id:"refer\xeancias",level:2}];function m(e){const a={a:"a",code:"code",em:"em",h2:"h2",img:"img",li:"li",p:"p",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,t.jsx)(a.p,{children:"Em um cen\xe1rio que um mesmo software \xe9 comercializado para diferentes clientes (tenants), \xe9 necess\xe1rio aplicar padr\xf5es de arquitetura que os isolem para que evitemos problemas como:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"Vazamento de dados"}),"\n",(0,t.jsx)(a.li,{children:"Compliance e regulat\xf3rios"}),"\n",(0,t.jsxs)(a.li,{children:["Impactos de performance em um cliente, causado por outro (",(0,t.jsx)(a.a,{href:"https://en.wikipedia.org/wiki/Cloud_computing_issues#Performance_interference_and_noisy_neighbors",children:"Noisy Neighbors"}),")"]}),"\n"]}),"\n",(0,t.jsx)(a.p,{children:"Em uma arquitetura multi-tenant, dependendo da maturidade do neg\xf3cio, necessidades contratuais e de or\xe7amento, diferentes estrat\xe9gias podem ser adotadas, dentre elas, destaco:"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Pool:"})," Share-Everything \u2014 Tenants compartilham recursos, mas s\xe3o isolados logicamente, por exemplo, no n\xedvel do schema do banco de dados."]}),"\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Silo:"})," Share-Nothing \u2014 Cada tenant tem recursos dedicados, proporcionando isolamento em n\xedvel de recurso, evitando o problema de Vizinhos Barulhentos (Noisy Neighbors)."]}),"\n",(0,t.jsxs)(a.li,{children:[(0,t.jsx)(a.strong,{children:"Bridge:"})," Abordagem h\xedbrida \u2014 Usa de servi\xe7os compartilhados, enquanto workloads cr\xedticos s\xe3o isolados a n\xedvel de recurso."]}),"\n"]}),"\n",(0,t.jsxs)(a.p,{children:["Neste artigo, apresento uma prova de conceito de uma arquitetura que segue a estrat\xe9gia ",(0,t.jsx)(a.strong,{children:"bridge"}),", com um \xfanico ponto de entrada, onde as solicita\xe7\xf5es s\xe3o direcionadas para o plano de aplica\xe7\xe3o correspondente a cada tenant."]}),"\n",(0,t.jsx)(a.p,{children:"A vantagem dessa solu\xe7\xe3o \xe9 que podemos compartilhar planos de aplica\xe7\xe3o com tenants menos cr\xedticos, isolando os mais importantes em silos dedicados. Por\xe9m, para isso, devemos tratar as aplica\xe7\xf5es como artefatos que possam ser implantados em diferentes planos, sem necessidade de duplicar c\xf3digo ou criar afinidades espec\xedficas com tenants."}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{alt:"Desenho de arquitetura",src:n(4365).A+"",width:"2000",height:"1537"})}),"\n",(0,t.jsx)(a.h2,{id:"containers",children:"Containers"}),"\n",(0,t.jsxs)(a.p,{children:["Cada tenant tem seu pr\xf3prio namespace, garantindo isolamento l\xf3gico dentro de um \xfanico cluster ",(0,t.jsx)(a.a,{href:"https://kubernetes.io/",children:"Kubernetes"}),". Nesta POC, n\xe3o aprofundo na distribui\xe7\xe3o e isolamento a n\xedvel de Nodes, no entanto, em um ambiente de produ\xe7\xe3o, os tenants podem ser isolados em diferentes grupos de n\xf3s usando node groups do ",(0,t.jsx)(a.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html",children:"EKS"}),", por exemplo, com base em sua criticidade."]}),"\n",(0,t.jsxs)(a.p,{children:["Para a aplica\xe7\xe3o, h\xe1 uma \xfanica fonte da verdade para o ",(0,t.jsx)(a.a,{href:"https://github.com/margato/multi-tenant-k8s/tree/main/apps/products-api",children:"c\xf3digo-fonte"})," que \xe9 gerenciado como um artefato pelo ",(0,t.jsx)(a.a,{href:"https://github.com/margato/multi-tenant-k8s/tree/main/infra/helm",children:"Helm"}),". Isso permite que a aplica\xe7\xe3o seja implantada em m\xfaltiplos namespaces enquanto apenas valores como limites de mem\xf3ria e CPU e configura\xe7\xe3o do Horizontal Pod Autoscaler (HPA) s\xe3o alterados."]}),"\n",(0,t.jsx)(a.h2,{id:"roteamento-e-autoriza\xe7\xe3o",children:"Roteamento e autoriza\xe7\xe3o"}),"\n",(0,t.jsxs)(a.p,{children:["A camada de roteamento \xe9 suportada pelo ",(0,t.jsx)(a.a,{href:"https://www.envoyproxy.io/",children:"Envoy Proxy"})," como um reverse proxy, e ",(0,t.jsx)(a.a,{href:"https://www.openpolicyagent.org/",children:"Open Policy Agent (OPA)"}),", fornecendo autoriza\xe7\xe3o ao plano de aplica\xe7\xe3o solicitado. A comunica\xe7\xe3o entre Envoy e OPA \xe9 feita por gRPC e localmente dentro do Pod, como um ",(0,t.jsx)(a.em,{children:"sidecar"}),", proporcionando baixa lat\xeancia."]}),"\n",(0,t.jsxs)(a.p,{children:["Cada solicita\xe7\xe3o \xe9 direcionada com base em um HTTP header nomeado como ",(0,t.jsx)(a.code,{children:"x-tenant-id"}),". Para fornecer seguran\xe7a, o OPA avalia o JWT fornecido para verificar se h\xe1 match entre o valor do header e os token claims, bem como para validar a exist\xeancia do tenant."]}),"\n",(0,t.jsxs)(a.p,{children:["Observe que essa implementa\xe7\xe3o ",(0,t.jsx)(a.em,{children:"Rego"})," n\xe3o valida a assinatura do JWT e nem a expira\xe7\xe3o do token, pois isso \xe9 apenas uma prova de conceito; em um ambiente de produ\xe7\xe3o, essa valida\xe7\xe3o \xe9 essencial."]}),"\n",(0,t.jsx)(a.h2,{id:"execute-localmente",children:"Execute localmente"}),"\n",(0,t.jsxs)(a.p,{children:["Para testar em sua m\xe1quina ou ver o c\xf3digo fonte da implementa\xe7\xe3o da POC, acesse o reposit\xf3rio original: ",(0,t.jsx)(a.a,{href:"https://github.com/margato/multi-tenant-k8s",children:"https://github.com/margato/multi-tenant-k8s"})]}),"\n",(0,t.jsx)(a.h2,{id:"refer\xeancias",children:"Refer\xeancias"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:(0,t.jsx)(a.a,{href:"https://docs.aws.amazon.com/whitepapers/latest/saas-architecture-fundamentals/re-defining-multi-tenancy.html",children:"Re-defining multi-tenancy"})}),"\n",(0,t.jsx)(a.li,{children:(0,t.jsx)(a.a,{href:"https://docs.aws.amazon.com/wellarchitected/latest/saas-lens/silo-pool-and-bridge-models.html",children:"Silo, Pool, Bridge Models"})}),"\n"]}),"\n","\n",(0,t.jsx)(i.A,{})]})}function u(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(m,{...e})}):m(e)}},5594:(e,a,n)=>{n.d(a,{A:()=>r});var o=n(4848),t=n(6540);function s({id:e,host:a,repo:s,repoId:i,category:r,categoryId:l,mapping:d,term:c,strict:m,reactionsEnabled:u,emitMetadata:p,inputPosition:h,theme:g,lang:f,loading:x}){const[j,b]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{j||n.e(416).then(n.bind(n,416)).then(()=>b(!0))},[]),j?(0,o.jsx)("giscus-widget",{id:e,host:a,repo:s,repoid:i,category:r,categoryid:l,mapping:d,term:c,strict:m,reactionsenabled:u,emitmetadata:p,inputposition:h,theme:g,lang:f,loading:x}):null}var i=n(5293);function r(){const{colorMode:e}=(0,i.G)();return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("hr",{}),(0,o.jsx)(s,{repo:"margato/blog",repoId:"R_kgDOPSXHYA",category:"General",categoryId:"DIC_kwDOPSXHYM4Ctayf",mapping:"pathname",reactionsEnabled:"1",emitMetadata:"0",inputPosition:"bottom",theme:"dark"===e?"dark":"light",lang:"en",loading:"lazy"})]})}},8453:(e,a,n)=>{n.d(a,{R:()=>i,x:()=>r});var o=n(6540);const t={},s=o.createContext(t);function i(e){const a=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),o.createElement(s.Provider,{value:a},e.children)}}}]);