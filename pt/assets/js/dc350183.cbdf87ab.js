"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[598],{2821:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/02-16-lambda-aws-fd083b2c53e081d5df1fde5a332ba9c1.png"},4116:e=>{e.exports=JSON.parse('{"permalink":"/pt/library/aws-lambda-finops-rds","source":"@site/blog/2022/02-16-finops.md","title":"Economizando na AWS \u2014 Desligando recursos fora do hor\xe1rio comercial","description":"A partir desse artigo, voc\xea conseguir\xe1 implementar um lambda na AWS para automatizar o desligamento de inst\xe2ncias em","date":"2022-02-16T00:00:00.000Z","tags":[{"inline":false,"label":"aws","permalink":"/pt/library/tags/aws","description":"Amazon\'s cloud platform offering scalable infrastructure, secure services, and powerful tools for modern software development."},{"inline":false,"label":"finops","permalink":"/pt/library/tags/finops","description":"A framework that blends financial accountability and cloud operations to optimize costs, improve transparency, and drive business value."}],"readingTime":4.45,"hasTruncateMarker":true,"authors":[{"name":"Osvaldo Margato","title":"Solutions Architect","url":"https://linkedin.com/in/margato","page":{"permalink":"/pt/library/authors/margato"},"socials":{"linkedin":"https://www.linkedin.com/in/margato/","github":"https://github.com/margato"},"imageURL":"https://github.com/margato.png","key":"margato"}],"frontMatter":{"slug":"aws-lambda-finops-rds","title":"Economizando na AWS \u2014 Desligando recursos fora do hor\xe1rio comercial","authors":"margato","tags":["aws","finops"]},"unlisted":false,"prevItem":{"title":"Implementando loop sequencial condicional no AWS Step Functions","permalink":"/pt/library/aws-step-functions-sequential-loop"}}')},5682:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/02-16-python-e97a4fa9a97ad8ed205e0eceff58f7c7.png"},5821:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>d,contentTitle:()=>r,default:()=>m,frontMatter:()=>t,metadata:()=>s,toc:()=>c});var s=n(4116),o=n(4848),i=n(8453);const t={slug:"aws-lambda-finops-rds",title:"Economizando na AWS \u2014 Desligando recursos fora do hor\xe1rio comercial",authors:"margato",tags:["aws","finops"]},r=void 0,d={authorsImageUrls:[void 0]},c=[{value:"Introdu\xe7\xe3o",id:"introdu\xe7\xe3o",level:2},{value:"Quanto ser\xe1 economizado?",id:"quanto-ser\xe1-economizado",level:2},{value:"Construindo a automa\xe7\xe3o",id:"construindo-a-automa\xe7\xe3o",level:2}];function l(e){const a={a:"a",code:"code",h2:"h2",img:"img",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(a.p,{children:"A partir desse artigo, voc\xea conseguir\xe1 implementar um lambda na AWS para automatizar o desligamento de inst\xe2ncias em\nhor\xe1rios que n\xe3o ser\xe3o utilizadas."}),"\n",(0,o.jsx)(a.h2,{id:"introdu\xe7\xe3o",children:"Introdu\xe7\xe3o"}),"\n",(0,o.jsx)(a.p,{children:"Utilizar servi\xe7os cloud \xe9 inevit\xe1vel nos dias atuais, seja para modernizar aplica\xe7\xf5es legado ou construir produtos escal\xe1veis de forma r\xe1pida. Contudo, \xe9 necess\xe1rio tomar cuidado com algo que muitas pessoas acabam ignorando ao desenvolver e implantar aplica\xe7\xf5es na nuvem: o custo."}),"\n",(0,o.jsx)(a.p,{children:"Para n\xe3o termos surpresas no final do m\xeas ao receber a fatura da AWS, \xe9 necess\xe1rio tomar algumas medidas preventivas. Nesse artigo, abordarei o desligamento de recursos nos ambientes de desenvolvimento em hor\xe1rios que n\xe3o ser\xe3o utilizados."}),"\n",(0,o.jsx)("center",{children:(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"Brace Yourselves, AWS Bill is Coming",src:n(7892).A+"",width:"300",height:"242"})})}),"\n",(0,o.jsx)(a.p,{children:"Sabe aquelas inst\xe2ncias RDS ou ECS Tasks nos ambientes de desenvolvimento que ficam paradas aos fins de semana? Ou ap\xf3s o fim do expediente? Vamos criar uma automa\xe7\xe3o para deslig\xe1-las fora do hor\xe1rio comercial, assim n\xe3o precisaremos nos preocupar em desligar manualmente e tamb\xe9m conseguiremos economizar bastante."}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"Architecture",src:n(6225).A+"",width:"566",height:"289"})}),"\n",(0,o.jsx)(a.h2,{id:"quanto-ser\xe1-economizado",children:"Quanto ser\xe1 economizado?"}),"\n",(0,o.jsx)(a.p,{children:"Para os c\xe1lculos de economia, utilizaremos a regi\xe3o US East (Ohio) e uma inst\xe2ncia RDS MySQL, db.m4.large, Single AZ, 2 vCPU, 8GB RAM, e 30GB SSD como par\xe2metro."}),"\n",(0,o.jsx)(a.p,{children:"Se deixarmos a inst\xe2ncia ligada 24h por dia, em uma semana teremos utilizado 168h, que resulta em, aproximadamente, $131."}),"\n",(0,o.jsxs)(a.p,{children:["Por\xe9m, se deixarmos a inst\xe2ncia ligada apenas no hor\xe1rio comercial, ou seja, das 9h as 18h, teremos em uma semana utilizado 45h, que resulta em, aproximadamente, $38. ",(0,o.jsx)(a.strong,{children:"Uma economia de mais de 70%"}),": $1116 de economia no ano."]}),"\n",(0,o.jsxs)(a.p,{children:["Lembre-se, s\xe3o ",(0,o.jsx)(a.strong,{children:"d\xf3lares"}),"! Al\xe9m disso, fizemos nosso c\xe1lculo para apenas uma inst\xe2ncia. Uma empresa pode possuir centenas ou milhares de inst\xe2ncias dependendo do porte."]}),"\n",(0,o.jsx)(a.h2,{id:"construindo-a-automa\xe7\xe3o",children:"Construindo a automa\xe7\xe3o"}),"\n",(0,o.jsx)(a.p,{children:"Para a automa\xe7\xe3o, construiremos um lambda em Python, que \xe9 estimulado por um agendamento para realizar a a\xe7\xe3o de ligar ou desligar as inst\xe2ncias RDS."}),"\n",(0,o.jsxs)(a.p,{children:["Para isso, utilizaremos o ",(0,o.jsx)(a.a,{href:"https://aws.amazon.com/serverless/sam/",children:"SAM"})," para facilitar o provisionamento e iniciar nosso projeto:"]}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.code,{children:"$ sam init"})}),"\n",(0,o.jsx)(a.p,{children:"Com o projeto criado, definiremos a infraestrutura do Lambda utilizando CloudFormation:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-yaml",children:'LambdaFunction:\n  Type: AWS::Serverless::Function\n  Properties:\n    FunctionName: startstop-instances\n    MemorySize: 128\n    Timeout: 10\n    Environment:\n      Variables:\n        REGIONS: !Ref Regions\n    Policies:\n      - Statement:\n          - Sid: RDSStartStopPolicy\n            Effect: Allow\n            Action:\n              - rds:DescribeDBInstances\n              - rds:StartDBInstance\n              - rds:StopDBInstance\n            Resource: \'*\'\n    CodeUri: src/\n    Handler: lambda_handler.lambda_handler\n    Runtime: python3.13\n    Events:\n      Start:\n        Type: Schedule\n        Properties:\n          Schedule: cron(0 12 ? * MON-FRI *)\n          Input: \'{"action": "start"}\'\n      Stop:\n        Type: Schedule\n        Properties:\n          Schedule: cron(0 20 ? * MON-FRI *)\n          Input: \'{"action": "stop"}\'\n'})}),"\n",(0,o.jsx)(a.p,{children:"Pelas policies, o lambda ter\xe1 acesso para listar, ligar e desligar as inst\xe2ncias de toda a conta, em qualquer regi\xe3o."}),"\n",(0,o.jsxs)(a.p,{children:["Tamb\xe9m foram definidos os dois eventos que estimular\xe3o a aplica\xe7\xe3o. O start, de segunda a sexta-feira, \xe0s 9h (12h UTC) e o stop, de segunda a sexta-feira, \xe0s 18h (20h UTC). O formato utilizado para esses par\xe2metros \xe9 no formato cron. Voc\xea tamb\xe9m pode utilizar algum gerador online para definir uma data ou hor\xe1rio espec\xedfico diferente do padr\xe3o: ",(0,o.jsx)(a.a,{href:"https://crontab.guru",children:"https://crontab.guru"}),"."]}),"\n",(0,o.jsx)(a.p,{children:"Al\xe9m disso, precisaremos definir o par\xe2metro Regions que ser\xe1 utilizado pelo lambda para varrer somente as regi\xf5es definidas:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-yaml",children:"Parameters:\n  Regions:\n    Type: String\n    Description: Regions which instances are going to be affected\n    Default: sa-east-1,us-east-1\n"})}),"\n",(0,o.jsx)(a.p,{children:"Agora que a infraestrutura est\xe1 definida. Iremos ao c\xf3digo Python:"}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"Estrutura de arquivos do c\xf3digo em python",src:n(5682).A+"",width:"211",height:"122"})}),"\n",(0,o.jsx)(a.p,{children:"lambda_handler.py \xe9 o entrypoint da nossa aplica\xe7\xe3o, esse arquivo cont\xe9m a fun\xe7\xe3o que ser\xe1 invocada."}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-python",children:"def lambda_handler(event, context):\n    action = event.get('action', 'undefined')\n\n    if action == 'start':\n        for service in services:\n            service.start_instances()\n    elif action == 'stop':\n        for service in services:\n            service.stop_instances()\n    else:\n        print('Unknown action:', action)\n\n    return {\n        \"statusCode\": 200\n    }\n"})}),"\n",(0,o.jsx)(a.p,{children:"O pacote services possui duas classes: ResourceService e RDSService. A classe ResourceService \xe9 uma classe abstrata. A partir dela, implementaremos a l\xf3gica de ligar e desligar as inst\xe2ncias."}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-python",children:"class ResourceService:\n    def __init__(self, regions: List[str]):\n        self.regions = regions\n        self.client = None\n\n    def start_instances(self) -> None:\n        pass\n\n    def stop_instances(self) -> None:\n        pass\n"})}),"\n",(0,o.jsx)(a.p,{children:"Nesse artigo, estamos focando apenas no servi\xe7o RDS, por\xe9m com essa estrutura, poder\xedamos, por exemplo, implementar para ECS Fargate com facilidade. Logo, implementaremos da seguinte forma:"}),"\n",(0,o.jsx)(a.pre,{children:(0,o.jsx)(a.code,{className:"language-python",children:"class RDSService(ResourceService):\n\n    def start_instances(self) -> None:\n        self.__for_instances(self.__start)\n\n    def stop_instances(self) -> None:\n        self.__for_instances(self.__stop)\n\n    def __for_instances(self, function: Callable):\n        for region in self.regions:\n            try:\n                self.client = boto3.client(RDS.CLIENT_NAME, region_name=region)\n            except Exception as e:\n                print(\"Cannot instantiate client in region\", region, e)\n                continue\n\n            pages = self.client.get_paginator(RDS.DESCRIBE_INSTANCES_COMMAND) \\\n                        .paginate(PaginationConfig={RDS.PAGE_SIZE: 30})\n\n            for page in pages:\n                for instance in page.get(RDS.INSTANCES):\n                    identifier = instance.get(RDS.IDENTIFIER)\n                    function(\n                        status=instance.get(RDS.STATUS),\n                        identifier=identifier\n                    )\n\n    def __start(self, status: str, identifier: str):\n        if status != 'stopped':\n            print(f'Instance \"{identifier}\" cannot be started. Current status: {status}')\n            return\n        self.client.start_db_instance(DBInstanceIdentifier=identifier)\n        print('Instance started:', identifier)\n\n    def __stop(self, status: str, identifier: str):\n        if status != 'available':\n            print(f'Instance \"{identifier}\" cannot be stopped. Current status: {status}')\n            return\n        self.client.stop_db_instance(DBInstanceIdentifier=identifier)\n        print('Instance stopped:', identifier)\n"})}),"\n",(0,o.jsx)(a.p,{children:"Na a\xe7\xe3o de start, validamos se a inst\xe2ncia est\xe1 parada, se estiver, ligaremos. J\xe1 na a\xe7\xe3o de stop, a valida\xe7\xe3o \xe9 a inversa: se estiver ligada, desligamos."}),"\n",(0,o.jsx)(a.p,{children:"Com o lambda implementado, podemos realizar o deploy na nossa conta AWS com o comando:"}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.code,{children:"$ sam deploy --guided"})}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"Lambda na AWS",src:n(2821).A+"",width:"620",height:"458"})}),"\n",(0,o.jsx)(a.p,{children:"Podemos testar nossa aplica\xe7\xe3o na aba Test, com o seguinte payload:"}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.code,{children:'{"action": "stop"}'})}),"\n",(0,o.jsx)(a.p,{children:(0,o.jsx)(a.img,{alt:"Execu\xe7\xe3o da Lambda",src:n(6068).A+"",width:"1325",height:"486"})}),"\n",(0,o.jsxs)(a.p,{children:["Todo o c\xf3digo mostrado nesse artigo est\xe1 dispon\xedvel por completo no ",(0,o.jsx)(a.a,{href:"https://github.com/margato/lambda-rds-startstop",children:"GitHub"}),"."]})]})}function m(e={}){const{wrapper:a}={...(0,i.R)(),...e.components};return a?(0,o.jsx)(a,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},6068:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/02-16-log-b75bdca8f266e3e2e35529cb767f9176.png"},6225:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/02-16-architecture-bd5a2a5e10e6b42f8a3d41e215a66618.png"},7892:(e,a,n)=>{n.d(a,{A:()=>s});const s=n.p+"assets/images/02-16-finops-meme-7bfb40c6eeb93edc28f669258e1680f0.png"},8453:(e,a,n)=>{n.d(a,{R:()=>t,x:()=>r});var s=n(6540);const o={},i=s.createContext(o);function t(e){const a=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:t(e.components),s.createElement(i.Provider,{value:a},e.children)}}}]);