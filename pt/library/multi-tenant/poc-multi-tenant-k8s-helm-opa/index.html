<!doctype html>
<html lang="pt-BR" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-multi-tenant/poc-multi-tenant-k8s-helm-opa" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Aplicações multi-tenant com Kubernetes e Helm | Osvaldo Margato</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://osvaldomargato.com/pt/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://osvaldomargato.com/pt/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://osvaldomargato.com/pt/library/multi-tenant/poc-multi-tenant-k8s-helm-opa"><meta data-rh="true" property="og:locale" content="pt_BR"><meta data-rh="true" property="og:locale:alternate" content="en_US"><meta data-rh="true" name="docusaurus_locale" content="pt"><meta data-rh="true" name="docsearch:language" content="pt"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Aplicações multi-tenant com Kubernetes e Helm | Osvaldo Margato"><meta data-rh="true" name="description" content="Introdução"><meta data-rh="true" property="og:description" content="Introdução"><link data-rh="true" rel="icon" href="/pt/img/logo.svg"><link data-rh="true" rel="canonical" href="https://osvaldomargato.com/pt/library/multi-tenant/poc-multi-tenant-k8s-helm-opa"><link data-rh="true" rel="alternate" href="https://osvaldomargato.com/pt/library/multi-tenant/poc-multi-tenant-k8s-helm-opa" hreflang="pt-BR"><link data-rh="true" rel="alternate" href="https://osvaldomargato.com/library/multi-tenant/poc-multi-tenant-k8s-helm-opa" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://osvaldomargato.com/library/multi-tenant/poc-multi-tenant-k8s-helm-opa" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Multi-tenant","item":"https://osvaldomargato.com/pt/library/multi-tenant"},{"@type":"ListItem","position":2,"name":"Aplicações multi-tenant com Kubernetes e Helm","item":"https://osvaldomargato.com/pt/library/multi-tenant/poc-multi-tenant-k8s-helm-opa"}]}</script><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5T0TTYC21F"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-5T0TTYC21F",{anonymize_ip:!0})</script>



<link rel="mask-icon" href="/img/logo-safari.png" color="#bbb3ff">
<link rel="apple-touch-icon" href="/img/logo.png"><link rel="stylesheet" href="/pt/assets/css/styles.00180768.css">
<script src="/pt/assets/js/runtime~main.4115f36b.js" defer="defer"></script>
<script src="/pt/assets/js/main.73fd1d1e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/pt/img/logo.svg"><div role="region" aria-label="Pular para o conteúdo principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Pular para o conteúdo principal</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Alternar a barra de navegação" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/pt/"><div class="navbar__logo"><img src="/pt/img/logo.svg" alt="Osvaldo Margato Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/pt/img/logo.svg" alt="Osvaldo Margato Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Osvaldo Margato</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pt/library">Library</a><a class="navbar__item navbar__link" href="/pt/library/tags">Tags</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Volte para o topo" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pt/library/">Knowledge Library</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/pt/library/multi-tenant">Multi-tenant</a><button aria-label="Fechar a categoria lateral &#x27;Multi-tenant&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pt/library/multi-tenant/poc-multi-tenant-k8s-helm-opa">Aplicações multi-tenant com Kubernetes e Helm</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/pt/library/finops">FinOps</a><button aria-label="Expandir a categoria lateral &#x27;FinOps&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Página Inicial" class="breadcrumbs__link" href="/pt/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/pt/library/multi-tenant"><span>Multi-tenant</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Aplicações multi-tenant com Kubernetes e Helm</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Nessa página</button></div><div class="theme-doc-markdown markdown"><header><h1>Aplicações multi-tenant com Kubernetes e Helm</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introdução">Introdução<a href="#introdução" class="hash-link" aria-label="Link direto para Introdução" title="Link direto para Introdução">​</a></h2>
<p>Em um cenário que um mesmo software é comercializado para diferentes clientes (tenants), é necessário aplicar padrões de arquitetura que os isolem para que evitemos problemas como:</p>
<ul>
<li>Vazamento de dados</li>
<li>Compliance e regulatórios</li>
<li>Impactos de performance em um cliente, causado por outro (<a href="https://en.wikipedia.org/wiki/Cloud_computing_issues#Performance_interference_and_noisy_neighbors" target="_blank" rel="noopener noreferrer">Noisy Neighbors</a>)</li>
</ul>
<p>Em uma arquitetura multi-tenant, dependendo da maturidade do negócio, necessidades contratuais e de orçamento, diferentes estratégias podem ser adotadas, dentre elas, destaco:</p>
<ul>
<li><strong>Pool:</strong> Share-Everything — Tenants compartilham recursos, mas são isolados logicamente, por exemplo, no nível do schema do banco de dados.</li>
<li><strong>Silo:</strong> Share-Nothing — Cada tenant tem recursos dedicados, proporcionando isolamento em nível de recurso, evitando o problema de Vizinhos Barulhentos (Noisy Neighbors).</li>
<li><strong>Bridge:</strong> Abordagem híbrida — Usa de serviços compartilhados, enquanto workloads críticos são isolados a nível de recurso.</li>
</ul>
<p>Neste artigo, apresento uma prova de conceito de uma arquitetura que segue a estratégia <strong>bridge</strong>, com um único ponto de entrada, onde as solicitações são direcionadas para o plano de aplicação correspondente a cada tenant.</p>
<p>A vantagem dessa solução é que podemos compartilhar planos de aplicação com tenants menos críticos, isolando os mais importantes em silos dedicados. Porém, para isso, devemos tratar as aplicações como artefatos que possam ser implantados em diferentes planos, sem necessidade de duplicar código ou criar afinidades específicas com tenants.</p>
<p><img decoding="async" loading="lazy" alt="Desenho de arquitetura" src="/pt/assets/images/poc-k8s-helm-opa-a0433a1c033d0c1e31f0d9086a9af9d6.png" width="2000" height="1537" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="containers">Containers<a href="#containers" class="hash-link" aria-label="Link direto para Containers" title="Link direto para Containers">​</a></h2>
<p>Cada tenant tem seu próprio namespace, garantindo isolamento lógico dentro de um único cluster <a href="https://kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubernetes</a>. Nesta POC, não aprofundo na distribuição e isolamento a nível de Nodes, no entanto, em um ambiente de produção, os tenants podem ser isolados em diferentes grupos de nós usando node groups do <a href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" target="_blank" rel="noopener noreferrer">EKS</a>, por exemplo, com base em sua criticidade.</p>
<p>Para a aplicação, há uma única fonte da verdade para o <a href="https://github.com/margato/multi-tenant-k8s/tree/main/apps/products-api" target="_blank" rel="noopener noreferrer">código-fonte</a> que é gerenciado como um artefato pelo <a href="https://github.com/margato/multi-tenant-k8s/tree/main/infra/helm" target="_blank" rel="noopener noreferrer">Helm</a>. Isso permite que a aplicação seja implantada em múltiplos namespaces enquanto apenas valores como limites de memória e CPU e configuração do Horizontal Pod Autoscaler (HPA) são alterados.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="roteamento-e-autorização">Roteamento e autorização<a href="#roteamento-e-autorização" class="hash-link" aria-label="Link direto para Roteamento e autorização" title="Link direto para Roteamento e autorização">​</a></h2>
<p>A camada de roteamento é suportada pelo <a href="https://www.envoyproxy.io/" target="_blank" rel="noopener noreferrer">Envoy Proxy</a> como um reverse proxy, e <a href="https://www.openpolicyagent.org/" target="_blank" rel="noopener noreferrer">Open Policy Agent (OPA)</a>, fornecendo autorização ao plano de aplicação solicitado. A comunicação entre Envoy e OPA é feita por gRPC e localmente dentro do Pod, como um <em>sidecar</em>, proporcionando baixa latência.</p>
<p>Cada solicitação é direcionada com base em um HTTP header nomeado como <code>x-tenant-id</code>. Para fornecer segurança, o OPA avalia o JWT fornecido para verificar se há match entre o valor do header e os token claims, bem como para validar a existência do tenant.</p>
<p>Observe que essa implementação <em>Rego</em> não valida a assinatura do JWT e nem a expiração do token, pois isso é apenas uma prova de conceito; em um ambiente de produção, essa validação é essencial.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="execute-localmente">Execute localmente<a href="#execute-localmente" class="hash-link" aria-label="Link direto para Execute localmente" title="Link direto para Execute localmente">​</a></h2>
<p>Para testar em sua máquina ou ver o código fonte da implementação da POC, acesse o repositório original: <a href="https://github.com/margato/multi-tenant-k8s" target="_blank" rel="noopener noreferrer">https://github.com/margato/multi-tenant-k8s</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="referências">Referências<a href="#referências" class="hash-link" aria-label="Link direto para Referências" title="Link direto para Referências">​</a></h2>
<ul>
<li><a href="https://docs.aws.amazon.com/whitepapers/latest/saas-architecture-fundamentals/re-defining-multi-tenancy.html" target="_blank" rel="noopener noreferrer">Re-defining multi-tenancy</a></li>
<li><a href="https://docs.aws.amazon.com/wellarchitected/latest/saas-lens/silo-pool-and-bridge-models.html" target="_blank" rel="noopener noreferrer">Silo, Pool, Bridge Models</a></li>
</ul>
<!-- -->
<hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-tags-row"><div class="col"><b>Marcadores:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" title="Kubernetes is an open-source system for automating container deployment, scaling, and management across infrastructure." class="tag_zVej tagRegular_sFm0" href="/pt/library/tags/k8s">Kubernetes</a></li><li class="tag_QGVx"><a rel="tag" title="A general-purpose policy engine that enables fine-grained access control and policy enforcement across cloud-native stacks." class="tag_zVej tagRegular_sFm0" href="/pt/library/tags/opa">Open Policy Agent</a></li><li class="tag_QGVx"><a rel="tag" title="Architecture pattern where a single software serves multiple customers (tenants) with strategies of data isolation and shared resources." class="tag_zVej tagRegular_sFm0" href="/pt/library/tags/multi-tenant">Multi-Tenant</a></li></ul></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Páginas de documentação"><a class="pagination-nav__link pagination-nav__link--prev" href="/pt/library/multi-tenant"><div class="pagination-nav__sublabel">Anterior</div><div class="pagination-nav__label">Multi-tenant</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pt/library/finops"><div class="pagination-nav__sublabel">Próxima</div><div class="pagination-nav__label">FinOps</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introdução" class="table-of-contents__link toc-highlight">Introdução</a></li><li><a href="#containers" class="table-of-contents__link toc-highlight">Containers</a></li><li><a href="#roteamento-e-autorização" class="table-of-contents__link toc-highlight">Roteamento e autorização</a></li><li><a href="#execute-localmente" class="table-of-contents__link toc-highlight">Execute localmente</a></li><li><a href="#referências" class="table-of-contents__link toc-highlight">Referências</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Discover more</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://linkedin.com/in/margato" target="_blank" rel="noopener noreferrer" class="footer__link-item">Linkedin<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/margato" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/margato/blog" target="_blank" rel="noopener noreferrer" class="footer__link-item">This website is open source<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">This is a space for studies and knowledge sharing. © 2025 Osvaldo Margato.</div></div></div></footer></div>
</body>
</html>